events {
    worker_connections 1024;
}

http {
    upstream auth_service {
        server auth-service:8001;
    }

    upstream report_service {
        server report-aggregator:8002;
    }

    upstream ai_service {
        server ai-analysis:8003;
    }

    upstream analytics_service {
        server analytics:8004;
    }

    upstream watcher_service {
        server report-watcher:8005;
    }

    server {
        listen 80;
        server_name localhost;

        # Increase timeouts for AI operations
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Increase max body size for file uploads
        client_max_body_size 100M;

        # Auth Service
        location /api/auth {
            rewrite ^/api/auth/(.*) /$1 break;
            proxy_pass http://auth_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Report Aggregator Service
        location /api/reports {
            rewrite ^/api/reports/(.*) /$1 break;
            proxy_pass http://report_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # AI Analysis Service
        location /api/ai {
            rewrite ^/api/ai/(.*) /$1 break;
            proxy_pass http://ai_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Analytics Service
        location /api/analytics {
            rewrite ^/api/analytics/(.*) /$1 break;
            proxy_pass http://analytics_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Report Watcher Service
        location /api/watcher {
            rewrite ^/api/watcher/(.*) /$1 break;
            proxy_pass http://watcher_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Health check
        location /health {
            return 200 "OK";
            add_header Content-Type text/plain;
        }
    }
}

